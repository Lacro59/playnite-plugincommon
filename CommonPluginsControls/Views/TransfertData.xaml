<UserControl x:Class="CommonPluginsControls.Views.TransfertData"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:converters="clr-namespace:CommonPluginsShared.Converters"
             xmlns:pConverters="clr-namespace:CommonPlayniteShared.Converters"
             mc:Ignorable="d"
             MinHeight="210" Width="960">

    <UserControl.Resources>
        <converters:DefaultIconConverter x:Key="DefaultIconConverter" />
        <pConverters:InvertedBooleanToVisibilityConverter x:Key="InvertedBooleanToVisibilityConverter" />

        <!-- ── Shared item template for both ComboBoxes ──────────────────────
             Layout: [  Game name ··················· ] [ badge ]
             - Name stretches and truncates with ellipsis.
             - Badge is a pill (CornerRadius=8) aligned to the right,
               coloured with NormalBorderBrush + GlyphBrush text.
             - Only one DataTemplate defined here; both ComboBoxes reference it
               via StaticResource to avoid duplication.
        ─────────────────────────────────────────────────────────────────── -->
        <DataTemplate x:Key="GameItemTemplate">
            <Grid Margin="2,2">
                <Grid.ColumnDefinitions>
                    <!-- Name column: stretches to fill available width -->
                    <ColumnDefinition Width="*" />
                    <!-- Spacer -->
                    <ColumnDefinition Width="8" />
                    <!-- Badge column: only as wide as needed -->
                    <ColumnDefinition Width="Auto" />
                </Grid.ColumnDefinitions>

                <!-- Game name -->
                <TextBlock Grid.Column="0"
                           VerticalAlignment="Center"
                           TextTrimming="CharacterEllipsis">
                    <TextBlock.Style>
                        <Style TargetType="TextBlock" BasedOn="{StaticResource BaseTextBlockStyle}">
                            <Style.Triggers>
                                <!-- Strike through + dim entries whose Playnite game was deleted -->
                                <DataTrigger Binding="{Binding IsDeleted}" Value="True">
                                    <Setter Property="TextDecorations" Value="Strikethrough" />
                                    <Setter Property="Foreground" Value="{DynamicResource TextBrushDarker}" />
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </TextBlock.Style>
                    <TextBlock.Text>
                        <Binding Path="Name" />
                    </TextBlock.Text>
                </TextBlock>

                <!-- Data-count badge pill -->
                <Border Grid.Column="2"
                        Background="{DynamicResource NormalBorderBrush}"
                        CornerRadius="8"
                        Padding="7,1"
                        VerticalAlignment="Center">
                    <TextBlock Style="{DynamicResource BaseTextBlockStyle}"
                               FontSize="11"
                               Foreground="{DynamicResource GlyphBrush}"
                               FontWeight="SemiBold"
                               Text="{Binding CountData}" />
                </Border>
            </Grid>
        </DataTemplate>
    </UserControl.Resources>

    <!-- ═══════════════════════════════════════════════════════════════════════
         Root card — SectionBorder from Common.xaml
         ═══════════════════════════════════════════════════════════════════════ -->
    <Border Style="{StaticResource SectionBorder}" Margin="10">
        <DockPanel LastChildFill="True">

            <!-- ─────────────────────────────────────────────────────────────
                 Bottom action bar
                 ───────────────────────────────────────────────────────────── -->
            <Border Style="{StaticResource TopSeparatorBorder}"
                    DockPanel.Dock="Bottom"
                    Margin="0,14,0,0">
                <DockPanel LastChildFill="False" Margin="0,10,0,0">

                    <Button DockPanel.Dock="Right"
                            Content="{DynamicResource LOCCloseLabel}"
                            Style="{StaticResource SecondaryButton}"
                            Command="{Binding CloseCommand}" />

                    <Button DockPanel.Dock="Right"
                            Content="{DynamicResource LOCCommonTransfer}"
                            Style="{StaticResource PrimaryButton}"
                            Command="{Binding TransferCommand}" />

                    <CheckBox DockPanel.Dock="Left"
                              Content="{DynamicResource LOCCommonMergedOrErased}"
                              Style="{StaticResource ModernCheckBox}"
                              IsChecked="{Binding IsMergeMode}"
                              VerticalAlignment="Center" />

                    <!-- Warning — visible only in overwrite mode (IsMergeMode = false) -->
                    <TextBlock DockPanel.Dock="Left"
                               Style="{DynamicResource BaseTextBlockStyle}"
                               Text="{DynamicResource LOCCommonErasedWarning}"
                               Foreground="{DynamicResource WarningBrush}"
                               FontWeight="SemiBold"
                               VerticalAlignment="Center"
                               Margin="16,0,0,0"
                               Visibility="{Binding IsMergeMode,
                                            Converter={StaticResource InvertedBooleanToVisibilityConverter}}" />
                </DockPanel>
            </Border>

            <!-- ─────────────────────────────────────────────────────────────
                 Main area — source | arrow | target
                 ───────────────────────────────────────────────────────────── -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="64" />
                    <ColumnDefinition Width="*" />
                </Grid.ColumnDefinitions>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto" />
                    <RowDefinition Height="8" />
                    <RowDefinition Height="Auto" />
                </Grid.RowDefinitions>

                <!-- Source column label -->
                <TextBlock Grid.Column="0" Grid.Row="0"
                           Style="{DynamicResource BaseTextBlockStyle}"
                           Text="{DynamicResource LOCCommonTransferSourceGame}"
                           Foreground="{DynamicResource TextBrushDarker}"
                           FontWeight="SemiBold"
                           FontSize="13" />

                <!-- Target column label -->
                <TextBlock Grid.Column="2" Grid.Row="0"
                           Style="{DynamicResource BaseTextBlockStyle}"
                           Text="{DynamicResource LOCCommonTransferTargetGame}"
                           Foreground="{DynamicResource TextBrushDarker}"
                           FontWeight="SemiBold"
                           FontSize="13" />

                <!-- ── Source ComboBox ─────────────────────────────────────
                     IsEditable=True        → user can type to filter.
                     IsTextSearchEnabled=False → disables WPF prefix search;
                       our accent-insensitive ICollectionView filter takes over.
                     StaysOpenOnEdit=True   → drop-down stays open while typing.
                     Text ↔ SearchTextSource → every keystroke triggers the filter.
                     SelectedItem ↔ SelectedSource → selection tracked separately.
                ─────────────────────────────────────────────────────────── -->
                <ComboBox Grid.Column="0" Grid.Row="2"
                          x:Name="PART_CbPluginGame"
                          SelectionChanged="PART_CbPluginGame_SelectionChanged"
                          Style="{StaticResource FilterComboBox}"
                          ItemsSource="{Binding SourceGamesView}"
                          SelectedItem="{Binding SelectedSource, Mode=TwoWay}"
                          Text="{Binding SearchTextSource, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          IsEnabled="{Binding IsSourceSelectable}"
                          IsEditable="True"
                          IsTextSearchEnabled="False"
                          StaysOpenOnEdit="True"
                          ItemTemplate="{StaticResource GameItemTemplate}"
                          VerticalAlignment="Center">
                    <ComboBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel VirtualizingStackPanel.IsVirtualizing="True"
                                                    VirtualizingStackPanel.VirtualizationMode="Recycling" />
                        </ItemsPanelTemplate>
                    </ComboBox.ItemsPanel>
                </ComboBox>

                <!-- Directional arrow (IcoFont glyph ea5d = arrow-right) -->
                <TextBlock Grid.Column="1" Grid.Row="2"
                           Style="{DynamicResource BaseTextBlockStyle}"
                           FontFamily="{DynamicResource FontIcoFont}"
                           Text="&#xea5d;"
                           FontSize="28"
                           Foreground="{DynamicResource GlyphBrush}"
                           HorizontalAlignment="Center"
                           VerticalAlignment="Center" />

                <!-- ── Target ComboBox ─────────────────────────────────────
                     Same configuration as the source ComboBox.
                     Uses the same shared GameItemTemplate.
                ─────────────────────────────────────────────────────────── -->
                <ComboBox Grid.Column="2" Grid.Row="2"
                          x:Name="PART_CbGame"
                          SelectionChanged="PART_CbGame_SelectionChanged"
                          Style="{StaticResource FilterComboBox}"
                          ItemsSource="{Binding TargetGamesView}"
                          SelectedItem="{Binding SelectedTarget, Mode=TwoWay}"
                          Text="{Binding SearchTextTarget, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                          IsEditable="True"
                          IsTextSearchEnabled="False"
                          StaysOpenOnEdit="True"
                          ItemTemplate="{StaticResource GameItemTemplate}"
                          VerticalAlignment="Center">
                    <ComboBox.ItemsPanel>
                        <ItemsPanelTemplate>
                            <VirtualizingStackPanel VirtualizingStackPanel.IsVirtualizing="True"
                                                    VirtualizingStackPanel.VirtualizationMode="Recycling" />
                        </ItemsPanelTemplate>
                    </ComboBox.ItemsPanel>
                </ComboBox>

            </Grid>
        </DockPanel>
    </Border>
</UserControl>